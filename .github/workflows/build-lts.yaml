name: Build KernelSU-Next with SUSFS and AnyKernel3 (LTS)

on:
  schedule:
    # Run daily at 02:00 UTC to catch updates
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  DEBIAN_FRONTEND: noninteractive
  KERNEL_TYPE: lts

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Maximize build space
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 512
        swap-size-mb: 1024
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git curl rsync build-essential bc bison flex libssl-dev libelf-dev lz4
        
        # Install repo
        mkdir -p ~/.bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/.bin/repo
        chmod a+x ~/.bin/repo
        echo "$HOME/.bin" >> $GITHUB_PATH

    - name: Set up Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git config --global init.defaultBranch main

    - name: Create workspace and get build info
      run: |
        mkdir -p workarea
        cd workarea
        
        # Generate build timestamp
        BUILD_DATE=$(date +"%Y%m%d")
        BUILD_TIME=$(date +"%H%M")
        BUILD_DATE_FORMATTED=$(date +"%Y-%m-%d")
        BUILD_TIME_FORMATTED=$(date +"%H:%M")
        KERNEL_NAME="kyernel-lts-${BUILD_DATE}-${BUILD_TIME}"
        
        echo "BUILD_DATE=${BUILD_DATE}" >> $GITHUB_ENV
        echo "BUILD_TIME=${BUILD_TIME}" >> $GITHUB_ENV
        echo "BUILD_DATE_FORMATTED=${BUILD_DATE_FORMATTED}" >> $GITHUB_ENV
        echo "BUILD_TIME_FORMATTED=${BUILD_TIME_FORMATTED}" >> $GITHUB_ENV
        echo "KERNEL_NAME=${KERNEL_NAME}" >> $GITHUB_ENV
        
        echo "Building: $KERNEL_NAME"

    - name: Clone repositories (force sync)
      run: |
        cd workarea
        
        # Force clone SUSFS repository for LTS
        echo "Force cloning SUSFS repository for LTS..."
        rm -rf susfs4ksu
        git clone https://gitlab.com/pershoot/susfs4ksu.git -b gki-android14-6.1-lts-dev
        
        # Force clone AnyKernel3
        echo "Force cloning AnyKernel3..."
        rm -rf AnyKernel3
        git clone https://github.com/enskye/AnyKernel3.git

    - name: Setup LTS kernel sources (force sync)
      run: |
        cd workarea
        
        # Clean and setup LTS kernel
        rm -rf gki-lts-kernel gki-kernel
        mkdir -p gki-lts-kernel
        
        # Setup LTS kernel with complete manifest
        cd gki-lts-kernel
        echo "Setting up LTS kernel sources with complete manifest..."
        
        # Initialize with LTS branch but ensure we get all components
        echo "Initializing repo with LTS manifest..."
        repo init -u https://android.googlesource.com/kernel/manifest -b common-android14-6.1-lts --depth=1
        
        echo "Starting complete repo sync..."
        # Force sync all projects including missing ones
        repo sync -c --no-tags --force-sync --no-repo-verify -j$(nproc)
        
        # If kernel/configs is still missing, try to sync it explicitly
        if [[ ! -d "kernel/configs" ]]; then
          echo "âš ï¸ kernel/configs missing, attempting explicit sync..."
          repo sync kernel/configs || {
            echo "Creating kernel/configs manually..."
            mkdir -p kernel/configs
            # Clone configs separately as fallback
            git clone --depth=1 https://android.googlesource.com/kernel/configs kernel/configs || echo "Configs clone failed"
          }
        fi
        
        # Check for other critical missing components and sync them
        MISSING_COMPONENTS=""
        
        if [[ ! -d "common-modules/virtual-device" ]]; then
          echo "âš ï¸ Syncing common-modules..."
          repo sync common-modules/virtual-device || MISSING_COMPONENTS="$MISSING_COMPONENTS virtual-device"
        fi
        
        if [[ ! -d "kernel/configs" ]]; then
          MISSING_COMPONENTS="$MISSING_COMPONENTS kernel/configs"
        fi
        
        if [[ ! -d "kernel/tests" ]]; then
          echo "âš ï¸ Syncing kernel/tests..."
          repo sync kernel/tests || MISSING_COMPONENTS="$MISSING_COMPONENTS kernel/tests"
        fi
        
        # Verify critical directories exist
        echo "Verifying repository structure..."
        REQUIRED_DIRS=("common" "build" "kernel/configs")
        for dir in "${REQUIRED_DIRS[@]}"; do
          if [[ ! -d "$dir" ]]; then
            echo "âŒ Required directory missing: $dir"
            echo "Available directories:"
            find . -maxdepth 2 -type d | head -20
            exit 1
          else
            echo "âœ… $dir"
          fi
        done
        
        # List repository structure for debugging
        echo "Repository structure:"
        find . -maxdepth 3 -type d | grep -E "(kernel|common)" | sort
        
        # Set up workspace
        if [[ -f "build/kernel/kleaf/bazel.WORKSPACE" ]]; then
          ln -sf build/kernel/kleaf/bazel.WORKSPACE WORKSPACE
          echo "âœ… WORKSPACE symlink created"
        else
          echo "âŒ bazel.WORKSPACE not found!"
          find . -name "bazel.WORKSPACE" -o -name "WORKSPACE*"
          exit 1
        fi
        
        if [[ -n "$MISSING_COMPONENTS" ]]; then
          echo "âš ï¸ Some components missing: $MISSING_COMPONENTS"
          echo "Continuing with available components..."
        fi
        
        echo "âœ… LTS kernel sources setup completed"

    - name: Create working directory
      run: |
        cd workarea
        
        # Create working directory for LTS build
        rm -rf gki-14-lts
        cp -r gki-lts-kernel gki-14-lts
        
        echo "WORK_DIR=gki-14-lts" >> $GITHUB_ENV
        echo "Working in: gki-14-lts"
        
        # Verify workspace structure
        cd gki-14-lts
        echo "Workspace verification:"
        ls -la
        
        # Check if WORKSPACE file exists and is correct
        if [[ -L "WORKSPACE" ]]; then
          echo "âœ… WORKSPACE symlink exists"
          ls -la WORKSPACE
        else
          echo "âŒ WORKSPACE symlink missing!"
          if [[ -f "build/kernel/kleaf/bazel.WORKSPACE" ]]; then
            ln -sf build/kernel/kleaf/bazel.WORKSPACE WORKSPACE
            echo "âœ… Created WORKSPACE symlink"
          fi
        fi

    - name: Copy SUSFS module and patches
      run: |
        cd workarea/gki-14-lts
        
        echo "Copying SUSFS files..."
        cp -p ../susfs4ksu/kernel_patches/fs/* common/fs/
        cp -p ../susfs4ksu/kernel_patches/include/linux/* common/include/linux/
        
        # Use LTS-specific patch if available, otherwise fallback
        cp -p ../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android14-6.1-lts.patch common/ 2>/dev/null || \
        cp -p ../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android14-6.1.patch common/
        
        cp -p ../susfs4ksu/kernel_patches/60_scope-minimized_manual_hooks.patch common/

    - name: Apply SUSFS patches
      run: |
        cd workarea/gki-14-lts/common
        
        echo "Applying SUSFS patches..."
        # Apply LTS patch if it exists, otherwise use regular patch
        if [[ -f "50_add_susfs_in_gki-android14-6.1-lts.patch" ]]; then
          patch -p1 -ui 50_add_susfs_in_gki-android14-6.1-lts.patch
        else
          patch -p1 -ui 50_add_susfs_in_gki-android14-6.1.patch
        fi
        
        patch -p1 -ui 60_scope-minimized_manual_hooks.patch

    - name: Setup KernelSU-Next
      run: |
        cd workarea/gki-14-lts
        
        echo "Setting up KernelSU-Next..."
        curl -LSs "https://raw.githubusercontent.com/pershoot/KernelSU-Next/refs/heads/next-susfs/kernel/setup.sh" | bash -s next-susfs

    - name: Remove protected exports and set version
      run: |
        cd workarea/gki-14-lts
        
        echo "Removing protected exports for Wi-Fi/Bluetooth compatibility..."
        sed -i '/^[[:space:]]*"protected_exports_list"[[:space:]]*:[[:space:]]*"android\/abi_gki_protected_exports_aarch64",$/d' common/BUILD.bazel
        rm -f common/android/abi_gki_protected_exports_*
        
        # Clean up patch files
        rm -f common/50_add_susfs_in_gki-android14-6.1*.patch common/60_scope-minimized_manual_hooks.patch
        
        # Set custom kernel version
        echo 'echo "-kyernel"' > common/scripts/setlocalversion

    - name: Commit changes
      run: |
        cd workarea/gki-14-lts/common
        
        git add -A
        git commit -m "Add KernelSU-Next with SUSFS integration - $KERNEL_NAME"

    - name: Build kernel
      run: |
        cd workarea/gki-14-lts
        
        echo "Pre-build verification..."
        echo "Current directory contents:"
        ls -la
        
        echo "Checking for required directories:"
        [[ -d "common" ]] && echo "âœ… common/" || echo "âŒ common/ missing"
        [[ -d "build" ]] && echo "âœ… build/" || echo "âŒ build/ missing"
        [[ -d "tools" ]] && echo "âœ… tools/" || echo "âŒ tools/ missing"
        [[ -d "prebuilts" ]] && echo "âœ… prebuilts/" || echo "âŒ prebuilts/ missing"
        [[ -d "kernel/configs" ]] && echo "âœ… kernel/configs/" || echo "âŒ kernel/configs/ missing"
        [[ -f "WORKSPACE" ]] && echo "âœ… WORKSPACE" || echo "âŒ WORKSPACE missing"
        
        # Show kernel/configs contents if it exists
        if [[ -d "kernel/configs" ]]; then
          echo "kernel/configs contents:"
          ls -la kernel/configs/ | head -10
        fi
        
        # Check workspace status manually
        echo "Testing workspace status..."
        tools/bazel info workspace 2>&1 || echo "Workspace info failed"
        
        # Try to query available targets first
        echo "Querying available kernel targets..."
        tools/bazel query "//common:*" 2>&1 | head -10 || echo "Query failed, continuing..."
        
        # If kernel/configs is still missing, try alternative build approach
        if [[ ! -d "kernel/configs" ]]; then
          echo "âš ï¸ kernel/configs missing, trying fallback build..."
          # Try building without dist target first
          tools/bazel build --config=fast --config=stamp --lto=thin --verbose_failures //common:kernel_aarch64 || {
            echo "âŒ Fallback build also failed"
            exit 1
          }
          
          # If successful, try to create dist manually
          echo "Creating distribution manually..."
          mkdir -p ../android-kernel
          find bazel-bin -name "Image*" -exec cp {} ../android-kernel/ \;
        else
          echo "Building kernel without signing..."
          tools/bazel run --config=fast --config=stamp --lto=thin --verbose_failures //common:kernel_aarch64_dist -- --dist_dir=../android-kernel
        fi

    - name: Prepare kernel image
      run: |
        cd workarea/android-kernel
        
        echo "Built artifacts:"
        ls -la
        
        # Find and prepare kernel image
        if [[ -f "Image" ]]; then
          echo "Compressing Image to Image.lz4..."
          lz4 -9 -f Image Image.lz4
          KERNEL_IMAGE="Image.lz4"
        elif [[ -f "Image.gz" ]]; then
          echo "Converting Image.gz to Image.lz4..."
          gunzip Image.gz
          lz4 -9 -f Image Image.lz4
          KERNEL_IMAGE="Image.lz4"
        else
          echo "âŒ No kernel image found!"
          exit 1
        fi
        
        echo "KERNEL_IMAGE=${KERNEL_IMAGE}" >> $GITHUB_ENV
        echo "âœ… Kernel image prepared and compressed: $KERNEL_IMAGE"
        echo "âœ… Image was signed during Bazel build process"

    - name: Create AnyKernel3 package
      run: |
        cd workarea
        
        echo "Preparing AnyKernel3 package..."
        cd AnyKernel3
        
        # Copy kernel image
        cp ../android-kernel/$KERNEL_IMAGE .
        
        # Create ZIP package
        ZIP_NAME="${KERNEL_NAME}.zip"
        zip -r9 "../$ZIP_NAME" . -x "*.git*" "README.md" "LICENSE"
        
        cd ..
        echo "âœ… Created: $ZIP_NAME"
        echo "Package size: $(du -h $ZIP_NAME | cut -f1)"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.KERNEL_NAME }}
        name: ${{ env.KERNEL_NAME }}
        body: |
          ## ðŸš€ LTS Kernel Build - ${{ env.KERNEL_NAME }}
          
          **Build Information:**
          - **Kernel Type**: LTS (Long Term Support)
          - **Build Date**: ${{ env.BUILD_DATE_FORMATTED }}
          - **Build Time**: ${{ env.BUILD_TIME_FORMATTED }} UTC
          - **Auto-built**: Daily sync and build
          
          **Components:**
          - âœ… **KernelSU-Next**: Latest with SUSFS integration
          - âœ… **SUSFS**: Advanced root hiding capabilities  
          - âœ… **AnyKernel3**: Universal flashing support
          - âœ… **Unsigned**: Fast build without signing overhead
          
          **Installation:**
          1. Download the ZIP file below
          2. Boot into custom recovery (TWRP/OrangeFox)
          3. Flash the ZIP file
          4. Reboot and enjoy!
          
          **Note**: This is an LTS build with enhanced stability and security features.
        files: |
          workarea/${{ env.KERNEL_NAME }}.zip
        draft: false
        prerelease: false

    - name: Upload raw kernel artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.KERNEL_NAME }}-raw-files
        path: workarea/android-kernel/
        retention-days: 7

    - name: Generate build summary
      run: |
        cd workarea
        
        echo "## ðŸš€ LTS Kernel Build Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Package Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Name**: \`$KERNEL_NAME\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Type**: LTS (Long Term Support)" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Date**: $BUILD_DATE_FORMATTED" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Time**: $BUILD_TIME_FORMATTED UTC" >> $GITHUB_STEP_SUMMARY
        echo "- **Package**: \`$KERNEL_NAME.zip\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Size**: $(du -h $KERNEL_NAME.zip | cut -f1)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ Build Components" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **KernelSU-Next**: Latest with SUSFS integration" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **SUSFS**: Advanced root hiding capabilities" >> $GITHUB_SUMMARY
        echo "- âœ… **AnyKernel3**: Universal flashing support" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Kernel Image**: \`$KERNEL_IMAGE\` (Unsigned)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Force Sync**: All sources updated" >> $GITHUB_STEP_SUMMARY        cd workarea
        
        # Force clone SUSFS repository for LTS
        echo "Force cloning SUSFS repository for LTS..."
        rm -rf susfs4ksu
        git clone https://gitlab.com/pershoot/susfs4ksu.git -b gki-android14-6.1-lts-dev
        
        # Force clone AnyKernel3
        echo "Force cloning AnyKernel3..."
        rm -rf AnyKernel3
        git clone https://github.com/enskye/AnyKernel3.git

    - name: Setup LTS kernel sources (force sync)
      run: |
        cd workarea
        
        # Clean and setup LTS kernel
        rm -rf gki-lts-kernel gki-kernel
        mkdir -p gki-lts-kernel
        
        # Setup LTS kernel with complete manifest
        cd gki-lts-kernel
        echo "Setting up LTS kernel sources with complete manifest..."
        
        # Initialize with LTS branch but ensure we get all components
        echo "Initializing repo with LTS manifest..."
        repo init -u https://android.googlesource.com/kernel/manifest -b common-android14-6.1-lts --depth=1
        
        echo "Starting complete repo sync..."
        # Force sync all projects including missing ones
        repo sync -c --no-tags --force-sync --no-repo-verify -j$(nproc)
        
        # If kernel/configs is still missing, try to sync it explicitly
        if [[ ! -d "kernel/configs" ]]; then
          echo "âš ï¸ kernel/configs missing, attempting explicit sync..."
          repo sync kernel/configs || {
            echo "Creating kernel/configs manually..."
            mkdir -p kernel/configs
            # Clone configs separately as fallback
            git clone --depth=1 https://android.googlesource.com/kernel/configs kernel/configs || echo "Configs clone failed"
          }
        fi
        
        # Check for other critical missing components and sync them
        MISSING_COMPONENTS=""
        
        if [[ ! -d "common-modules/virtual-device" ]]; then
          echo "âš ï¸ Syncing common-modules..."
          repo sync common-modules/virtual-device || MISSING_COMPONENTS="$MISSING_COMPONENTS virtual-device"
        fi
        
        if [[ ! -d "kernel/configs" ]]; then
          MISSING_COMPONENTS="$MISSING_COMPONENTS kernel/configs"
        fi
        
        if [[ ! -d "kernel/tests" ]]; then
          echo "âš ï¸ Syncing kernel/tests..."
          repo sync kernel/tests || MISSING_COMPONENTS="$MISSING_COMPONENTS kernel/tests"
        fi
        
        # Verify critical directories exist
        echo "Verifying repository structure..."
        REQUIRED_DIRS=("common" "build" "kernel/configs")
        for dir in "${REQUIRED_DIRS[@]}"; do
          if [[ ! -d "$dir" ]]; then
            echo "âŒ Required directory missing: $dir"
            echo "Available directories:"
            find . -maxdepth 2 -type d | head -20
            exit 1
          else
            echo "âœ… $dir"
          fi
        done
        
        # List repository structure for debugging
        echo "Repository structure:"
        find . -maxdepth 3 -type d | grep -E "(kernel|common)" | sort
        
        # Set up workspace
        if [[ -f "build/kernel/kleaf/bazel.WORKSPACE" ]]; then
          ln -sf build/kernel/kleaf/bazel.WORKSPACE WORKSPACE
          echo "âœ… WORKSPACE symlink created"
        else
          echo "âŒ bazel.WORKSPACE not found!"
          find . -name "bazel.WORKSPACE" -o -name "WORKSPACE*"
          exit 1
        fi
        
        if [[ -n "$MISSING_COMPONENTS" ]]; then
          echo "âš ï¸ Some components missing: $MISSING_COMPONENTS"
          echo "Continuing with available components..."
        fi
        
        echo "âœ… LTS kernel sources setup completed"

    - name: Create working directory
      run: |
        cd workarea
        
        # Create working directory for LTS build
        rm -rf gki-14-lts
        cp -r gki-lts-kernel gki-14-lts
        
        echo "WORK_DIR=gki-14-lts" >> $GITHUB_ENV
        echo "Working in: gki-14-lts"
        
        # Verify workspace structure
        cd gki-14-lts
        echo "Workspace verification:"
        ls -la
        
        # Check if WORKSPACE file exists and is correct
        if [[ -L "WORKSPACE" ]]; then
          echo "âœ… WORKSPACE symlink exists"
          ls -la WORKSPACE
        else
          echo "âŒ WORKSPACE symlink missing!"
          if [[ -f "build/kernel/kleaf/bazel.WORKSPACE" ]]; then
            ln -sf build/kernel/kleaf/bazel.WORKSPACE WORKSPACE
            echo "âœ… Created WORKSPACE symlink"
          fi
        fi

    - name: Copy SUSFS module and patches
      run: |
        cd workarea/gki-14-lts
        
        echo "Copying SUSFS files..."
        cp -p ../susfs4ksu/kernel_patches/fs/* common/fs/
        cp -p ../susfs4ksu/kernel_patches/include/linux/* common/include/linux/
        
        # Use LTS-specific patch if available, otherwise fallback
        cp -p ../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android14-6.1-lts.patch common/ 2>/dev/null || \
        cp -p ../susfs4ksu/kernel_patches/50_add_susfs_in_gki-android14-6.1.patch common/
        
        cp -p ../susfs4ksu/kernel_patches/60_scope-minimized_manual_hooks.patch common/

    - name: Apply SUSFS patches
      run: |
        cd workarea/gki-14-lts/common
        
        echo "Applying SUSFS patches..."
        # Apply LTS patch if it exists, otherwise use regular patch
        if [[ -f "50_add_susfs_in_gki-android14-6.1-lts.patch" ]]; then
          patch -p1 -ui 50_add_susfs_in_gki-android14-6.1-lts.patch
        else
          patch -p1 -ui 50_add_susfs_in_gki-android14-6.1.patch
        fi
        
        patch -p1 -ui 60_scope-minimized_manual_hooks.patch

    - name: Setup KernelSU-Next
      run: |
        cd workarea/gki-14-lts
        
        echo "Setting up KernelSU-Next..."
        curl -LSs "https://raw.githubusercontent.com/pershoot/KernelSU-Next/refs/heads/next-susfs/kernel/setup.sh" | bash -s next-susfs

    - name: Remove protected exports and set version
      run: |
        cd workarea/gki-14-lts
        
        echo "Removing protected exports for Wi-Fi/Bluetooth compatibility..."
        sed -i '/^[[:space:]]*"protected_exports_list"[[:space:]]*:[[:space:]]*"android\/abi_gki_protected_exports_aarch64",$/d' common/BUILD.bazel
        rm -f common/android/abi_gki_protected_exports_*
        
        # Clean up patch files
        rm -f common/50_add_susfs_in_gki-android14-6.1*.patch common/60_scope-minimized_manual_hooks.patch
        
        # Set custom kernel version
        echo 'echo "-kyernel"' > common/scripts/setlocalversion

    - name: Commit changes
      run: |
        cd workarea/gki-14-lts/common
        
        git add -A
        git commit -m "Add KernelSU-Next with SUSFS integration - $KERNEL_NAME"

    - name: Setup signing keys for Bazel
      run: |
        cd workarea/gki-14-lts
        
        # Create signing keys directory
        mkdir -p signing
        
        if [[ -n "${{ secrets.KERNEL_SIGNING_KEY }}" && -n "${{ secrets.KERNEL_SIGNING_CERT }}" ]]; then
          echo "Setting up kernel signing keys from GitHub Secrets..."
          echo "${{ secrets.KERNEL_SIGNING_KEY }}" | base64 -d > signing/kernel_key.pem
          echo "${{ secrets.KERNEL_SIGNING_CERT }}" | base64 -d > signing/kernel_cert.pem
          SIGNING_ARGS="--action_env=KBUILD_SIGN_PIN= --action_env=KBUILD_SIGN_CERT=signing/kernel_cert.pem --action_env=KBUILD_SIGN_KEY=signing/kernel_key.pem"
        else
          echo "No signing keys found in secrets, generating temporary keys for development..."
          # Generate temporary self-signed keys for development builds
          openssl genrsa -out signing/kernel_key.pem 4096
          openssl req -new -x509 -key signing/kernel_key.pem -out signing/kernel_cert.pem -days 365 -subj "/C=US/ST=Dev/L=Build/O=Kyernel/CN=kyernel-lts"
          SIGNING_ARGS="--action_env=KBUILD_SIGN_PIN= --action_env=KBUILD_SIGN_CERT=signing/kernel_cert.pem --action_env=KBUILD_SIGN_KEY=signing/kernel_key.pem"
          echo "âš ï¸ Using temporary development keys. For production, add KERNEL_SIGNING_KEY and KERNEL_SIGNING_CERT to repository secrets."
        fi
        
        echo "SIGNING_ARGS=${SIGNING_ARGS}" >> $GITHUB_ENV
        echo "âœ… Kernel signing keys prepared"

    - name: Build kernel
      run: |
        cd workarea/gki-14-lts
        
        echo "Pre-build verification..."
        echo "Current directory contents:"
        ls -la
        
        echo "Checking for required directories:"
        [[ -d "common" ]] && echo "âœ… common/" || echo "âŒ common/ missing"
        [[ -d "build" ]] && echo "âœ… build/" || echo "âŒ build/ missing"
        [[ -d "tools" ]] && echo "âœ… tools/" || echo "âŒ tools/ missing"
        [[ -d "prebuilts" ]] && echo "âœ… prebuilts/" || echo "âŒ prebuilts/ missing"
        [[ -d "kernel/configs" ]] && echo "âœ… kernel/configs/" || echo "âŒ kernel/configs/ missing"
        [[ -f "WORKSPACE" ]] && echo "âœ… WORKSPACE" || echo "âŒ WORKSPACE missing"
        
        # Show kernel/configs contents if it exists
        if [[ -d "kernel/configs" ]]; then
          echo "kernel/configs contents:"
          ls -la kernel/configs/ | head -10
        fi
        
        # Check workspace status manually
        echo "Testing workspace status..."
        tools/bazel info workspace 2>&1 || echo "Workspace info failed"
        
        # Try to query available targets first
        echo "Querying available kernel targets..."
        tools/bazel query "//common:*" 2>&1 | head -10 || echo "Query failed, continuing..."
        
        # If kernel/configs is still missing, try alternative build approach
        if [[ ! -d "kernel/configs" ]]; then
          echo "âš ï¸ kernel/configs missing, trying fallback build..."
          # Try building without dist target first
          tools/bazel build --config=fast --config=stamp --lto=thin --verbose_failures $SIGNING_ARGS //common:kernel_aarch64 || {
            echo "âŒ Fallback build also failed"
            exit 1
          }
          
          # If successful, try to create dist manually
          echo "Creating distribution manually..."
          mkdir -p ../android-kernel
          find bazel-bin -name "Image*" -exec cp {} ../android-kernel/ \;
        else
          echo "Building kernel with signing enabled..."
          tools/bazel run --config=fast --config=stamp --lto=thin --verbose_failures $SIGNING_ARGS //common:kernel_aarch64_dist -- --dist_dir=../android-kernel
        fi

    - name: Prepare kernel image
      run: |
        cd workarea/android-kernel
        
        echo "Built artifacts:"
        ls -la
        
        # Find and prepare kernel image
        if [[ -f "Image" ]]; then
          echo "Compressing Image to Image.lz4..."
          lz4 -9 -f Image Image.lz4
          KERNEL_IMAGE="Image.lz4"
        elif [[ -f "Image.gz" ]]; then
          echo "Converting Image.gz to Image.lz4..."
          gunzip Image.gz
          lz4 -9 -f Image Image.lz4
          KERNEL_IMAGE="Image.lz4"
        else
          echo "âŒ No kernel image found!"
          exit 1
        fi
        
        echo "KERNEL_IMAGE=${KERNEL_IMAGE}" >> $GITHUB_ENV
        echo "âœ… Kernel image prepared and compressed: $KERNEL_IMAGE"
        echo "âœ… Image was signed during Bazel build process"

    - name: Create AnyKernel3 package
      run: |
        cd workarea
        
        echo "Preparing AnyKernel3 package..."
        cd AnyKernel3
        
        # Copy kernel image
        cp ../android-kernel/$KERNEL_IMAGE .
        
        # Create ZIP package
        ZIP_NAME="${KERNEL_NAME}.zip"
        zip -r9 "../$ZIP_NAME" . -x "*.git*" "README.md" "LICENSE"
        
        cd ..
        echo "âœ… Created: $ZIP_NAME"
        echo "Package size: $(du -h $ZIP_NAME | cut -f1)"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ env.KERNEL_NAME }}
        name: ${{ env.KERNEL_NAME }}
        body: |
          ## ðŸš€ LTS Kernel Build - ${{ env.KERNEL_NAME }}
          
          **Build Information:**
          - **Kernel Type**: LTS (Long Term Support)
          - **Build Date**: ${{ env.BUILD_DATE_FORMATTED }}
          - **Build Time**: ${{ env.BUILD_TIME_FORMATTED }} UTC
          - **Auto-built**: Daily sync and build
          
          **Components:**
          - âœ… **KernelSU-Next**: Latest with SUSFS integration
          - âœ… **SUSFS**: Advanced root hiding capabilities  
          - âœ… **AnyKernel3**: Universal flashing support
          - âœ… **Signed**: Image signed by default
          
          **Installation:**
          1. Download the ZIP file below
          2. Boot into custom recovery (TWRP/OrangeFox)
          3. Flash the ZIP file
          4. Reboot and enjoy!
          
          **Note**: This is an LTS build with enhanced stability and security features.
        files: |
          workarea/${{ env.KERNEL_NAME }}.zip
        draft: false
        prerelease: false

    - name: Upload raw kernel artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.KERNEL_NAME }}-raw-files
        path: workarea/android-kernel/
        retention-days: 7

    - name: Generate build summary
      run: |
        cd workarea
        
        echo "## ðŸš€ LTS Kernel Build Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Package Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Name**: \`$KERNEL_NAME\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Type**: LTS (Long Term Support)" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Date**: $BUILD_DATE_FORMATTED" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Time**: $BUILD_TIME_FORMATTED UTC" >> $GITHUB_STEP_SUMMARY
        echo "- **Package**: \`$KERNEL_NAME.zip\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Size**: $(du -h $KERNEL_NAME.zip | cut -f1)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ Build Components" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **KernelSU-Next**: Latest with SUSFS integration" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **SUSFS**: Advanced root hiding capabilities" >> $GITHUB_SUMMARY
        echo "- âœ… **AnyKernel3**: Universal flashing support" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Kernel Image**: \`$KERNEL_IMAGE\` (Signed)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Force Sync**: All sources updated" >> $GITHUB_STEP_SUMMARY
